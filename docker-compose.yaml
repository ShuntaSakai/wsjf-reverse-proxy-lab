services: #どんなコンテナを作るか
  # ==========================
  # 攻撃者クライアント（フロント側）
  # ==========================
  attacker-inline: #定義スタート
    container_name: attacker-inline #コンテナ名を固定

    #attkcerフォルダのDockerfieを使う
    #（docker-compose の build はディレクトリを指定すると、
    #その中の Dockerfile を自動的に参照する仕様になっているため、
    #使用するファイル名を明示する必要がない。)
    build: ./attacker

    cap_add:
      - NET_ADMIN #ネットワークのルーティングなどの設定を変更できる
      - NET_RAW ##TCP/IPの中身を自分で書けるようになり、通常禁止されている攻撃が可能に
    networks:
      front_net:
        ipv4_address: 192.168.10.10
    command: tail -f /dev/null #空のファイルを見続ける(コマンドの実行が終了しないことでコンテナを生き残らせ続けられる)

    #本環境では volume 機能を用いて、
    #攻撃者コンテナ内の作業ディレクトリ /workspace を
    #ホスト側ディレクトリと共有することで、
    #攻撃ログやパケットキャプチャを永続的に保存可能としている。
    volumes:
      - ./attacker/data:/workspace 

  # ==========================
  # WSJF付きリバースプロキシ
  # ==========================
  reverse_proxy:
    build: ./reverse_proxy
    container_name: reverse_proxy
    cap_add:
      - NET_ADMIN
      - NET_RAW
    networks:
      front_net:
        ipv4_address: 192.168.10.30   # クライアント（攻撃者）側IP
      back_net:
        ipv4_address: 192.168.20.30   # サーバ（被害者）側IP
    environment:
      - TZ=Asia/Tokyo
    command: python3 proxy.py   # TODO: 中身を書く
    volumes:
      - ./reverse_proxy/app:/app # PCのフォルダappとコンテナ内のフォルダappを同じ中身に(ログやデータが残る)

  # ==========================
  # 被害者Webサーバ（バック側）
  # ==========================
  victim-inline:
    build: ./victim
    container_name: victim-inline
    cap_add:
      - NET_ADMIN
      - NET_RAW
    networks:
      back_net:
        ipv4_address: 192.168.20.20
    command: apachectl -D FOREGROUND #Apacheサーバーを動かし続ける
    volumes:
      - ./victim/data:/var/www/html #ホストのフォルダdata内のhtmlファイルをサーバと同期させる(htmlを変更すれば実行中でも変更される)

  # ==========================
  # Zeek（バック側監視）
  # ==========================
  zeek-inline:
    build: ./zeek
    container_name: zeek-inline
    networks:
      back_net:
        ipv4_address: 192.168.20.2
      front_net:
        ipv4_address: 192.168.10.2

    environment:
      - TZ=Asia/Tokyo
    cap_add:
      - NET_ADMIN
      - NET_RAW
    command: tail -f /dev/null
    volumes:
      - ./zeek/logs:/zeek-logs #結果を保存しておく
      - ./zeek/scripts:/zeek-scripts #zeekの検知ルールの変更が可能
      - ./bin/zeek-color:/usr/local/bin/zeek-color #zeekのログを見やすく色づけ

networks:
  # フロント側ネットワーク（攻撃者・クライアント側）
  front_net:
    driver: bridge #Docker 標準の「普通の LAN」を使う
    internal: true
    ipam:
      config:
        - subnet: 192.168.10.0/24

  # バック側ネットワーク（被害者・Webサーバ側）
  back_net:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 192.168.20.0/24
